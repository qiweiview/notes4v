# mqtt协议


## 协议结构

```
| 7    | 6    | 5    | 4    | 3    | 2    | 1    | 0    |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|         4位报文类型         |          4位标志位         |
|                       剩余长度                         |
```

* 固定报头的第一字节的4-7位的值指定了报文类型，其取值如下表。

```
报文类型	值	描述
CONNECT	1	客户端向代理发起连接请求
CONNACK	2	连接确认
PUBLISH	3	发布消息
PUBACK	4	发布确认
PUBREC	5	发布收到（QoS2）
PUBREL	6	发布释放（QoS2）
PUBCOMP	7	发布完成（QoS2）
SUBSCRIBE	8	客户端向代理发起订阅请求
SUBACK	9	订阅确认
UNSUBSCRIBE	10	取消订阅
UNSUBACK	11	取消订阅确认
PINGREQ	12	PING请求
PINGRESP	13	PING响应
DISCONNECT	14	断开连接
```

* 0和15为系统保留值；0-3位为标志位，依照报文类型有不同的含义。
* 事实上，除了 PUBLISH 报文以外，其他报文的标志位均为系统保留。如果收到报文的标志位无效，代理应断开连接
* 固定报头的第二字节起表示报文的剩余长度。最大4个字节，每字节可以编码至127，并含有一位继续位，如继续位非0，则下一字节依然为剩余长度。由此，理论上一个控制报文最长可以到256MB
* 一些报文在固定报头和荷载之间可以有一个可变报头。可变报头的内容根据报文类型不同而不同。最常见的可变报头是报文标识符（PacketIdentifier）


