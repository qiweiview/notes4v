## 网络层

### 转发与路由

转发：将分组从路由器的输入端口转移到合适的输出端口

路由：确定分组从源到目的经过的路径 

转发表：用来确定在本路由器如何转发分组（路由算法）

### 连接建立（并不是所有网络都需要建立）

数据分组传输前两端主机需要我首先建立虚拟/逻辑连接，网络设备（路由器）参与连接的建立
```
与传输层连接比较

网络层连接：两个主机之间（路径上的路由器等网络设备参与其中）

传输层连接：两个应用进程之间（中间网络设备透明）
```

#### 网络服务模型（best effort）

无连接服务：
* 不事先为系列分组传输确定传输路径
* 每个分组独立确定传输路径
* 不同分组可能传输路径不同
* 数据报网络

数据报网络（Internet代表）：
* 网络层无连接
* 每个分组携带目的地址
* 路由器根据分组的目的地址转发分组（基于路由协议/算法构建转发表）（检索转发表）（每份分组独立选路）
* 数据转发表

1. 针对地址范围

![](https://i.loli.net/2019/06/22/5d0e011ff0f5d22494.png)

2. 最长前缀匹配优先

![](https://i.loli.net/2019/06/22/5d0e0213d66f348379.png)



连接服务：
* 首先为系列分组的传输确定从源到目的经过的路径（建立链接）
* 然后沿该路径（连接）传输系列分组
* 系列分组传输路径相同
* 传输结束后拆除连接
* 虚电路网络

虚电路（Virtual Circuits）（ATM代表）：
* 一条从源主机到目的主机，类似电路的路径（逻辑连接）
* 是分组交换，每个分组的传输利用链路的全部带宽
* 源到目的的路径经过的呃网络层设备共同完成虚电路功能
* 呼叫建立（call setup）->数据传输->拆除呼叫
* 每个分组携带虚电路标识（VCID）而不是目的主机的地址
* 链路，网络设备资源（带宽，缓存）可以面向VC进行预分配

虚电路包括：

* 从源主机到目的主机的一条路径
* 虚电路号（VCID）,沿路每段链路一个编号（反映通讯能力）（采用局部化）
* 沿每个网络层设备，利用转发表记录经过的每个虚电路
* 同一条VC在每段链路上的VCID通常不同（路由器转发分组时依据转发表改写/替换虚电路号）

![](https://i.loli.net/2019/06/22/5d0dfc5397ef469581.png)

* 虚电路信令协议（用VC建立维护拆除）(Internet不采用)

![](https://i.loli.net/2019/06/22/5d0dffcb9b20914328.png)


数据报网络和虚电路网络比较

![](https://i.loli.net/2019/06/22/5d0e02b1de1ec33250.png)

### Internet网络（典型的数据报网络）

![](https://i.loli.net/2019/06/22/5d0e035aa970073191.png)

#### IP数据报

![](https://i.loli.net/2019/06/22/5d0e062f5293d42274.png)

* 版本号，占4比特
* 首部长度，占4比特，IP分组首部长度（4字节为单位）
* 服务类型，占8位，值期望活的哪种类型的服务（区分服务）
* 总长度，占16位（首部+数据）
* 生存时间，占8位，IP分组在网络中可以通过的路由器数（跳步数，路由器转发1次TTL减1）（如果TTL=0路由器则丢弃IP分组）
* 协议，占8位，指示IP分组封装的是哪个协议的数据包
* 首部校验和，占16位，实现对IP分组首部的差错检测（逐跳计算）
* 源IP地址：32位标识发送分组的源主机/路由（网络接口）
* 目的IP地址：32位标识接收分组的源主机/路由（网络接口）
* 选项，长度可变，1-40b,携带安全信息，源路径，时间戳
* 填充，0-3b,补充整个首部，符合32位对齐

#### 分片与重组 
* 网络链路存在MTU（最大传输单元）
* 大IP分组向小MTU链路转发时，可以被分片（并不是一定）
* 路由器只分不装（目的主机装）


IP协议中：
* 标识（ID）占16位，标识一个IP分组（利用一个计数器，每产生一个IP分组计数器就+1作为该IP分组的标识）
* 标志位，占3位（保留位，DF,MF）

![](https://i.loli.net/2019/06/22/5d0e08d0affb318469.png)

* 片偏移，占13位，一个IP分组分片封装原IP分组数据的相对偏移量（8字节为单位）

IP分片过程：

![](https://i.loli.net/2019/06/22/5d0e09f37a1a758066.png)

![](https://i.loli.net/2019/06/22/5d0e0a9178f3571128.png)


#### IP编址
* IP地址：32比特编号标识主机，路由器的接口（与每个接口关联）
* 分为网络号（高比特位）和主机号（低比特位）

![](https://i.loli.net/2019/06/22/5d0e10051227128540.png)

* 有类地址划分

![](https://i.loli.net/2019/06/22/5d0e117de863795479.png)

* 特殊IP地址

![](https://i.loli.net/2019/06/22/5d0e1209288f851734.png)

* 私有地址
目的地址包含这些网络的地址，IP分组会被丢掉

![](https://i.loli.net/2019/06/22/5d0e1fa17349c64141.png)

#### IP子网划分

网络号（NetId）：高比特位
子网号（SubId）：原网络主机号部分比特
主机号（HostId）：低位比特

![](https://i.loli.net/2019/06/22/5d0e5015602cc95609.png)

#### IP子网掩码（32位）

![](https://i.loli.net/2019/06/23/5d0e51796369c30682.png)

![](https://i.loli.net/2019/06/23/5d0e5296b09e032539.png)
 
* 借用主机位的高几位作为子网号（划分4个子网，那么借用2位00，01，10，11）
* 子网地址：网络位固定，主机位全0到全1
* 可分配地址：去掉主机位全0，和主机位全1






