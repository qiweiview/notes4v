## CIDR（无类别域间路由，Classless Inter-Domain Routing）
* 消除传统有类地址界限
* NetId网络号+SubId子网号=Network Prefix（网络前缀）(可以是任意长度)
* 无类地址格式a.b.c.d/x,x是前缀长度

```
200.23.16.0/23

11001000 00010111 00010000 00000000

前23位是Prefix

子网：
201.2.3.64
11001001 00000010 00000011 01000000

255.255.255.192
11111111 11111111 11111111 11000000

直接写成210.2.3.61/26
```

```
例如：
已知一个IP地址是：128.14.35.7/20，那么这个已知条件告诉大家的并不仅仅是一个IP地址这么简单，我们来分析一下。
128.14.35.7/20 = 10000000  00001110  00100011  00000111
即前20位是网络前缀，后12位是主机号，那么我们通过令主机号分别为全0和全1就可以得到一个CIDR地址块的最小地址和最大地址，即
最小地址是：128.14.32.0      = 10000000  00001110  00100000  00000000 
最大地址是：128.14.47.255  = 10000000  00001110  00101111 11111111     
子网掩码是：255.255.240.0  = 11111111  11111111  11110000  00000000 
因此就可以看出来，这个CIDR地址块可以指派(47-32+1)*256=4096个地址，这里没有把全0和全1除外。
```

![](https://i.loli.net/2019/06/26/5d136b033033265758.png)

* 提高IPV4地址空间分配效率
* 提高路由效率（路由聚合）

## DHCP协议（应用层）

### 获取IP途径
* 硬编码（静态配置）（默认网关指的是数据出子网要往哪里送）

![](https://i.loli.net/2019/06/24/5d10d74a63b4663249.png)

* DHCP动态主机设置协议（英语：Dynamic Host Configuration Protocol）
1. （即插即用）
2.（允许地址重用）
3. （支持在用地址续租）
4. （支持移动用户加入网络）
5. （从服务器动态获取：IP地址，子网掩码，默认网关地址，DNS服务器名称与IP地址）


```
DHCP交换过程


主机广播："DHCP discover"(发现报文)(查看谁可以提供DHCP服务)
DHCP服务器利用"DHCP offer"(提供报文)进行响应
主机请求IP地址："DHCP request"(请求报文)
DHCP服务器分配IP地址"DHCP ACK"(确认报文)
```
图例
![](https://i.loli.net/2019/06/25/5d115f1c2537a55330.png)


## NAT(网络地址转换Network Address Translation)
* 所有离开本地网络去往Internet的数据报的源IP地址需替换为相同的NAT IP地址，以及不同的端口号
* 动机：只能/只需从ISP申请一个IP地址，IPV4耗尽，内部网络对外部不可见

### 实现
替换：利用（NAT IP地址，新的端口号）替换每个外出IP数据报的（源IP地址，源端口号）
记录：将每对（NAT IP地址，新端接口）与（源IP地址，源端口号）的替换信息存储到NAT转换表中
替换：根据NAT转换表，利用（源IP地址，源端口号）替换每个进入内网IP数据报的（目的地址，目的端口号），即（NAT IP地址，新端口号）

过程
![](https://i.loli.net/2019/06/26/5d12ad3d9ca5d37306.png)

### 存在问题
* 16-bit端口号字段，支持60000多并行连接
* NAT存在争议，路由器应该只能处理第三层功能，违背端到端原则

### NAT穿透

方法1：静态配置配置NAT,将制定端口的 连接请求转发给网服务器

方法2：利用Universal Plug and Play(即插即用 )Internet Gateway Device互联网网管设备协议自动配置
* 学习到NAT公共IP地址
* 在NAT转换表中，增删端口映射

方法3：中继（如skype）
* NAT内部客户与中继服务器建立连接
* 外部客户也与中继服务器建立连接
* 中继服务器桥接两个连接的分组

## ICMP互联网控制报文协议
* 支持主机或者路由器发送差错报告
* 网络探寻

### 两类ICMP报文(封装到IP数据报中)

差错报文：
1. 目的不可达
2. 源抑制
3. 超时/超期（ttl=0）
4. 参数问题
5. 重定向

网络探寻：
1. 回声请求与应答报文（Ping）
2. 时间戳请求与应答报文

![](https://i.loli.net/2019/06/26/5d12b12b6971821220.png)

![](https://i.loli.net/2019/06/26/5d12b26d59a2082541.png)

应用
![](https://i.loli.net/2019/06/26/5d1366360ad4d33814.png)

## IPV6
* 固定长度40自建的基本首部（课拓展首部，路由器不处理，加快速度）
* 不允许分片

![](https://i.loli.net/2019/06/26/5d136792e976796622.png)

* 移除校验和，较少每跳处理时间
* 允许选项，但是从基本首部移除，定义多个选项首部，通过“下一个首部”字段指示
* 附加报文类型“packet Too Big”
* 地址128个比特位，分割成8组，写成16进制，连续多个0可以用冒号表示（只能用一次）
* 不再使用子网掩码
* URL中IPV6地址使用中括号“[]”括起来

### IPV4和IPV6共存
* 通过隧道，IPV6数据报作为IPV4数据报的载荷进行封装，穿越IPV4(依赖双协议路由器)